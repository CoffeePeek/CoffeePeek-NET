@page
@using CoffeePeek.Domain.Enums.Shop
@model ModerationModel
@{
    ViewData["Title"] = "Модерация заявок";
    Layout = "_Layout";
}

<div class="page-header">
    <h1 class="page-title">Модерация заявок</h1>
</div>

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Filter Pills -->
<div class="filter-pills">
    <a href="?filter=Pending" class="filter-pill @(string.IsNullOrEmpty(ViewContext.HttpContext.Request.Query["filter"].ToString()) || ViewContext.HttpContext.Request.Query["filter"].ToString() == "Pending" ? "active" : "")">
        Ожидает
        <i class="fas fa-chevron-down dropdown-icon"></i>
    </a>
    <a href="?filter=Approved" class="filter-pill @(ViewContext.HttpContext.Request.Query["filter"].ToString() == "Approved" ? "active" : "")">
        Одобрено
        <i class="fas fa-chevron-down dropdown-icon"></i>
    </a>
    <a href="?filter=Rejected" class="filter-pill @(ViewContext.HttpContext.Request.Query["filter"].ToString() == "Rejected" ? "active" : "")">
        Отклонено
        <i class="fas fa-chevron-down dropdown-icon"></i>
    </a>
</div>

@if (Model.ReviewShops == null || !Model.ReviewShops.Any())
{
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <h3>Нет заявок на модерацию</h3>
        <p>Все заявки обработаны</p>
    </div>
}
else
{
    <div class="submissions-table">
        <table class="table">
            <thead>
                <tr>
                    <th>Изображение</th>
                    <th>Название кофейни</th>
                    <th>Местоположение</th>
                    <th>Дата заявки</th>
                    <th class="actions-header">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var shop in Model.ReviewShops)
                {
                    <tr>
                        <td>
                            <div class="shop-image">
                                @if (shop.ShopPhotos != null && shop.ShopPhotos.Any())
                                {
                                    <img src="@shop.ShopPhotos.First()" alt="@shop.Name" />
                                }
                                else
                                {
                                    <i class="fas fa-coffee"></i>
                                }
                            </div>
                        </td>
                        <td>
                            <p class="shop-name">@shop.Name</p>
                        </td>
                        <td>
                            <p class="shop-location">@shop.NotValidatedAddress</p>
                        </td>
                        <td>
                            <p class="shop-date">@DateTime.Now.AddDays(-new Random(shop.Id).Next(0, 30)).ToString("d/M/yy")</p>
                        </td>
                        <td>
                            @if (shop.ReviewStatus == ReviewStatus.Pending)
                            {
                                <div class="action-buttons">
                                    <form method="post" asp-page-handler="UpdateStatus" class="d-inline">
                                        <input type="hidden" name="id" value="@shop.Id" />
                                        <input type="hidden" name="status" value="Approved" />
                                        <button type="submit" class="btn-action btn-approve" 
                                                onclick="return confirm('Одобрить заявку на кофейню «@shop.Name»?');">
                                            <i class="fas fa-check"></i> Одобрить
                                        </button>
                                    </form>
                                    <form method="post" asp-page-handler="UpdateStatus" class="d-inline">
                                        <input type="hidden" name="id" value="@shop.Id" />
                                        <input type="hidden" name="status" value="Rejected" />
                                        <button type="submit" class="btn-action btn-reject" 
                                                onclick="return confirm('Отклонить заявку на кофейню «@shop.Name»?');">
                                            <i class="fas fa-times"></i> Отклонить
                                        </button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <span class="text-muted" style="font-size: 0.875rem;">
                                    @if (shop.ReviewStatus == ReviewStatus.Approved)
                                    {
                                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-times-circle" style="color: var(--danger);"></i>
                                    }
                                    Обработано
                                </span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        // Автоматически скрывать сообщения через 5 секунд
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    </script>
}
