@page
@model IndexModel
@{
    ViewData["Title"] = "Home - CoffeePeek";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: #667eea !important;
            font-size: 1.5rem;
        }

        .main-container {
            padding: 40px 20px;
        }

        .welcome-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .welcome-card h1 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .test-card h3 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-card .icon {
            font-size: 24px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-test {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            color: white;
            transition: transform 0.2s;
        }

        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .btn-logout {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .method-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .method-get {
            background: #28a745;
            color: white;
        }

        .method-post {
            background: #007bff;
            color: white;
        }

        .method-delete {
            background: #dc3545;
            color: white;
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
        <a class="navbar-brand" href="/">
            ☕ CoffeePeek
        </a>
        <div class="ms-auto">
            @if (Model.IsAuthenticated)
            {
                <span class="me-3">👤 @Model.UserEmail</span>
                <form method="post" asp-page-handler="Logout" class="d-inline">
                    <button type="submit" class="btn btn-test btn-logout btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            }
            else
            {
                <a href="/Auth/Login" class="btn btn-test btn-sm">
                    <i class="fas fa-sign-in-alt"></i> Login
                </a>
            }
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4 text-center">☕ Coffee Shops Feed</h2>

    @if (Model.ResponseData?.CoffeeShopDtos is { Length: > 0 } shops)
    {
        <div class="d-flex flex-column gap-3">
            @foreach (var shop in shops)
            {
                <div class="card shadow-sm">
                    <div class="card-body d-flex">
                        @if (shop.ShopPhotos?.Count > 0)
                        {
                            <img src="@shop.ShopPhotos.FirstOrDefault()?.Url" alt="@shop.Name" class="rounded me-3" style="width:150px; height:150px; object-fit:cover;">
                        }
                        else
                        {
                            <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded me-3" 
                                 style="width:150px; height:150px;">
                                No Photo
                            </div>
                        }

                        <div class="flex-grow-1">
                            <h4 class="card-title">@shop.Name</h4>
                            <p class="card-text text-muted mb-2">@shop.Description</p>
                            
                            @if (shop.Address is not null)
                            {
                                <p class="mb-1">
                                    <i class="bi bi-geo-alt"></i> 
                                    @shop.Address.CityName, @shop.Address.StreetName @shop.Address.BuildingNumber
                                </p>
                            }

                            @if (shop.ShopContact is not null)
                            {
                                <p class="mb-1">
                                    <i class="bi bi-telephone"></i> @shop.ShopContact.PhoneNumber
                                    @if (!string.IsNullOrWhiteSpace(shop.ShopContact.InstagramLink))
                                    {
                                        <br />
                                        <a href="@shop.ShopContact.InstagramLink" target="_blank" class="text-decoration-none text-primary">
                                            <i class="bi bi-instagram"></i> Instagram
                                        </a>
                                    }
                                </p>
                            }

                            @if (shop.Schedules?.Count > 0)
                            {
                                <small class="text-muted">
                                    🕒 Schedule:
                                    @{
                                        var today = shop.Schedules.FirstOrDefault(s => s.DayOfWeek == DateTime.Today.DayOfWeek);
                                        if (today != null)
                                        {
                                            if (today.IsOpen24Hours)
                                            {
                                                <span>Open 24h</span>;
                                            }
                                            else
                                            {
                                                <span>@today.OpeningTime:hh\\:mm - @today.ClosingTime:hh\\:mm</span>;
                                            }
                                        }
                                    }
                                </small>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center mt-5">
            No coffee shops found ☹️
        </div>
    }
</div>

<div class="container main-container">
    <div class="welcome-card">
        <h1>🧪 API Testing Dashboard</h1>
        <p class="text-muted mb-0">Test your CoffeePeek API endpoints easily</p>

        @if (Model.IsAuthenticated)
        {
            <div class="user-info">
                <strong>✅ Authenticated</strong>
                <div class="small mt-1">Email: @Model.UserEmail</div>
                <div class="small">Token: @(Model.AccessToken != null && Model.AccessToken.Length > 50 ? Model.AccessToken.Substring(0, 50) : Model.AccessToken)...</div>
            </div>
        }
        else
        {
            <div class="alert alert-warning alert-custom mt-3">
                <i class="fas fa-exclamation-triangle"></i> You are not authenticated. Some API calls may fail. <a href="/Login">Login here</a>
            </div>
        }
    </div>

    <div class="row">
        <!-- Redis Cache Testing -->
        <div class="col-lg-6">
            <div class="test-card">
                <h3>
                    <i class="fas fa-database icon"></i>
                    Redis Cache
                </h3>

                <form method="post" asp-page-handler="RedisTest">
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <select class="form-select" name="redisAction" required>
                            <option value="">Select action...</option>
                            <option value="set">Set Value</option>
                            <option value="get">Get Value</option>
                            <option value="delete">Delete Key</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Key</label>
                        <input type="text" class="form-control" name="redisKey" placeholder="mykey" required/>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Value (for Set)</label>
                        <textarea class="form-control" name="redisValue" rows="3" placeholder='{"name": "John", "age": 30}'></textarea>
                    </div>

                    <button type="submit" class="btn btn-test w-100">
                        <i class="fas fa-play"></i> Execute
                    </button>
                </form>

                @if (!string.IsNullOrEmpty(Model.RedisResult))
                {
                    <div class="result-box">
                        <strong>Result:</strong>
                        <pre>@Model.RedisResult</pre>
                    </div>
                }
            </div>
        </div>

        <!-- Auth API Testing -->
        <div class="col-lg-6">
            <div class="test-card">
                <h3>
                    <i class="fas fa-user-shield icon"></i>
                    Auth API
                    <span class="method-badge method-post">POST</span>
                </h3>

                <form method="post" asp-page-handler="CheckEmail">
                    <div class="mb-3">
                        <label class="form-label">Check if Email Exists</label>
                        <div class="input-group">
                            <input type="email" class="form-control" name="emailToCheck" placeholder="test@example.com" required/>
                            <button type="submit" class="btn btn-test">
                                <i class="fas fa-search"></i> Check
                            </button>
                        </div>
                    </div>
                </form>

                @if (!string.IsNullOrEmpty(Model.EmailCheckResult))
                {
                    <div class="result-box">
                        <strong>Result:</strong>
                        <pre>@Model.EmailCheckResult</pre>
                    </div>
                }
            </div>

            <div class="test-card">
                <h3>
                    <i class="fas fa-sync-alt icon"></i>
                    Refresh Token
                    <span class="method-badge method-get">GET</span>
                </h3>

                <form method="post" asp-page-handler="RefreshToken">
                    <div class="mb-3">
                        <label class="form-label">Refresh Token</label>
                        <input type="text" class="form-control" name="refreshToken" placeholder="Enter refresh token" value="@Model.RefreshToken"/>
                    </div>

                    <button type="submit" class="btn btn-test w-100">
                        <i class="fas fa-redo"></i> Refresh Token
                    </button>
                </form>

                @if (!string.IsNullOrEmpty(Model.RefreshTokenResult))
                {
                    <div class="result-box">
                        <strong>Result:</strong>
                        <pre>@Model.RefreshTokenResult</pre>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Custom API Endpoint Testing -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="test-card">
                <h3>
                    <i class="fas fa-code icon"></i>
                    Custom API Endpoint
                </h3>

                <form method="post" asp-page-handler="CustomApi">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Method</label>
                            <select class="form-select" name="httpMethod" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>

                        <div class="col-md-9 mb-3">
                            <label class="form-label">Endpoint URL</label>
                            <input type="text" class="form-control" name="apiEndpoint" placeholder="/api/Auth/check-exists?email=test@test.com" required/>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Request Body (JSON) - Optional</label>
                        <textarea class="form-control" name="apiBody" rows="4" placeholder='{"key": "value"}'></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="includeAuth" id="includeAuth" checked/>
                        <label class="form-check-label" for="includeAuth">
                            Include Authorization Token
                        </label>
                    </div>

                    <button type="submit" class="btn btn-test">
                        <i class="fas fa-paper-plane"></i> Send Request
                    </button>
                </form>

                @if (!string.IsNullOrEmpty(Model.CustomApiResult))
                {
                    <div class="result-box">
                        <strong>Response:</strong>
                        <pre>@Model.CustomApiResult</pre>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>